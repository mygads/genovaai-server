import{i,r as g,g as u,a as h}from"./api-BefMeM7B.js";const l="genovaai-analyze";chrome.runtime.onInstalled.addListener(()=>{try{chrome.contextMenus.create({id:l,title:"GenovaAI",contexts:["selection"]}),console.log("âœ… Context menu created")}catch(o){console.error("âŒ Failed to create context menu:",o)}chrome.alarms.create("refreshToken",{periodInMinutes:1380}),chrome.alarms.create("checkSession",{periodInMinutes:30}),console.log("GenovaAI Extension (Backend) installed")});chrome.alarms.onAlarm.addListener(async o=>{if(o.name==="refreshToken")if(await i())if(console.log("ðŸ”„ Auto-refreshing access token (scheduled check)..."),await g())console.log("âœ… Token refreshed successfully");else{console.error("âŒ Token refresh failed - session may be invalid");try{chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"GenovaAI Session Issue",message:"Could not refresh your session. Please login again.",priority:2})}catch(e){console.warn("Could not show notification:",e)}}else console.log("â­ï¸ Skipping token refresh - not authenticated");if(o.name==="checkSession"){const n=await i();console.log(n?"âœ… Session is still valid":"â­ï¸ Not authenticated - skipping session check")}});chrome.runtime.onMessage.addListener((o,n,s)=>{if(o.type==="CHECK_AUTH")return i().then(e=>{s({authenticated:e})}),!0;if(o.type==="GET_SESSION_ID")return u().then(e=>{s({sessionId:e})}),!0});chrome.contextMenus.onClicked.addListener(async(o,n)=>{if(o.menuItemId!==l||!n?.id)return;const s=o.selectionText;if(!s||s.trim()===""){a(n.id,"No text selected");return}try{console.log("ðŸ” Checking authentication...");const e=await i();if(console.log("ðŸ” isAuthenticated result:",e),!e){console.error("âŒ Not authenticated!"),a(n.id,"Your session has expired. Please login again in Settings.");try{chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"Login Required",message:"Please login in GenovaAI extension settings to continue.",priority:2})}catch(t){console.warn("Could not show notification:",t)}return}console.log("ðŸš€ Processing question with GenovaAI (Backend)..."),console.log("ðŸ“ Question:",s.substring(0,100)+"...");try{await chrome.tabs.sendMessage(n.id,{type:"GENOVA_LOADING"}),console.log("âœ¨ Loading indicator sent")}catch(t){console.warn("âš ï¸ Could not send loading indicator:",t)}console.log("ðŸ“¡ Calling askQuestion API...");const r=await h(null,s);if(console.log("ðŸ“¦ API result:",{success:r.success,error:r.error,hasData:!!r.data}),!r.success)throw console.error("âŒ API call failed:",r.error),new Error(r.error||"Failed to get answer");const c=r.data?.answer||"No answer received";console.log("âœ… Answer received from backend"),console.log("ðŸ“Š History ID:",r.data?.historyId),console.log("ðŸ“ Answer preview:",c.substring(0,100)+"...");const d={type:"GENOVA_RESULT",answer:c};try{await chrome.tabs.sendMessage(n.id,d),console.log("âœ… Message sent to tab successfully")}catch(t){console.error("Failed to send message to tab:",t),console.warn("Content script may not be available on this page")}}catch(e){console.error("âŒ Error in background script:",e),console.error("Error details:",{name:e instanceof Error?e.name:"Unknown",message:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:"No stack trace"});const r=e instanceof Error?e.message:"An error occurred";await a(n.id,r)}});async function a(o,n){const s={type:"GENOVA_ERROR",error:n};try{await chrome.tabs.sendMessage(o,s),console.log("âœ… Error message sent to tab")}catch(e){console.error("Failed to send error message to tab:",e),console.warn("Content script may not be available on this page")}}chrome.action.onClicked.addListener(()=>{chrome.runtime.openOptionsPage()});console.log("GenovaAI Background Service Worker (Backend) loaded");
