const n={AUTH_DATA:"genovaai_auth",CURRENT_SESSION_ID:"genovaai_current_session"};async function u(e){try{console.log("üíæ Saving auth data to chrome.storage.local..."),await chrome.storage.local.set({[n.AUTH_DATA]:e}),console.log("‚úÖ Auth data saved successfully")}catch(o){throw console.error("‚ùå Error saving auth data:",o),o}}async function c(){try{return(await chrome.storage.local.get(n.AUTH_DATA))[n.AUTH_DATA]||null}catch(e){return console.error("‚ùå Error getting auth data:",e),null}}async function h(){try{console.log("üö™ Logging out..."),await chrome.storage.local.remove([n.AUTH_DATA,n.CURRENT_SESSION_ID]),chrome.runtime.sendMessage({type:"LOGOUT"}).catch(()=>{}),console.log("‚úÖ Logged out successfully")}catch(e){throw console.error("‚ùå Error during logout:",e),e}}async function p(){const e=await c();if(!e)return console.log("‚ùå Not authenticated: No auth data"),!1;const o=Date.now(),r=e.expiresAt-o;return r<=0?(console.log("‚ùå Not authenticated: Token expired",{expiredAt:new Date(e.expiresAt).toISOString(),now:new Date(o).toISOString(),expiredAgo:Math.abs(Math.floor(r/1e3))+"s"}),!1):(console.log("‚úÖ Authenticated: Token valid for",Math.floor(r/1e3),"seconds"),!0)}async function w(){try{return(await chrome.storage.local.get(n.CURRENT_SESSION_ID))[n.CURRENT_SESSION_ID]||null}catch(e){return console.error("‚ùå Error getting session ID:",e),null}}const a="https://genova.genfity.com";async function d(){try{const e=await c();if(!e?.refreshToken)return console.error("‚ùå No refresh token available"),!1;console.log("üîÑ Refreshing access token...");const o=await fetch(`${a}/api/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e.refreshToken})}),r=await o.json();if(!r.success)return console.error("‚ùå Token refresh failed:",r.error),o.status===401&&(console.log("üö™ Session invalid, logging out..."),await h(),chrome.tabs.query({},l=>{l.forEach(g=>{g.id&&chrome.tabs.sendMessage(g.id,{type:"AUTH_ERROR",message:"Session expired. Please login again."}).catch(()=>{})})})),!1;const t=(r.data.expiresIn||604800)*1e3,s={...e,accessToken:r.data.accessToken,expiresAt:Date.now()+t};return await u(s),console.log("‚úÖ Access token refreshed, expires in",r.data.expiresIn,"seconds"),!0}catch(e){return console.error("‚ùå Error refreshing token:",e),!1}}async function f(){const e=await c();if(!e)return console.warn("‚ö†Ô∏è No auth data available"),null;const o=120*1e3,r=e.expiresAt-Date.now();return r<=o?(console.log("üîÑ Token expired or expiring soon, refreshing..."),await d()?(await c())?.accessToken||null:(console.error("‚ùå Failed to refresh token"),null)):(console.log(`‚úÖ Token valid for ${Math.floor(r/1e3)}s more`),e.accessToken)}async function i(e,o={}){console.log("üîµ fetchWithAuth called:",{url:e,method:o.method||"GET"});const r=await f();if(!r)throw console.error("‚ùå No token available"),new Error("Not authenticated");console.log("üîë Token available, making request...");const t=await fetch(e,{...o,headers:{...o.headers,Authorization:`Bearer ${r}`}});if(console.log("üì• Response:",t.status,t.statusText),t.status===401)if(await d()){const l=await f();return fetch(e,{...o,headers:{...o.headers,Authorization:`Bearer ${l}`}})}else throw console.log("üö™ Cannot refresh token, logging out..."),await h(),new Error("Session expired. Please login again.");return t}async function T(e){try{const r=await(await fetch(`${a}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();if(r.success){const t=(r.data.expiresIn||604800)*1e3,s={accessToken:r.data.accessToken,refreshToken:r.data.refreshToken,user:r.data.user,expiresAt:Date.now()+t};await u(s)}return r}catch(o){return console.error("Register error:",o),{success:!1,message:"Network error"}}}async function y(e){try{const r=await(await fetch(`${a}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();if(r.success){const t=(r.data.expiresIn||604800)*1e3,s={accessToken:r.data.accessToken,refreshToken:r.data.refreshToken,user:r.data.user,expiresAt:Date.now()+t};await u(s)}return r}catch(o){return console.error("Login error:",o),{success:!1,message:"Network error"}}}async function k(){try{await i(`${a}/api/auth/logout`,{method:"POST"}).catch(()=>{})}catch(e){console.error("Logout error:",e)}finally{await h()}}async function A(){try{return await(await i(`${a}/api/customer/genovaai/profile`)).json()}catch(e){return console.error("Get profile error:",e),{success:!1,message:"Network error"}}}async function S(e=20,o=0){try{return await(await i(`${a}/api/customer/genovaai/sessions?limit=${e}&offset=${o}`)).json()}catch(r){return console.error("Get sessions error:",r),{success:!1,message:"Network error"}}}async function m(e,o){try{console.log("üîµ askQuestion called:",{endpoint:`${a}/api/gateway/ask`,sessionId:e||"AUTO (backend will select active session)",questionLength:o.length});const r={question:o},t=await i(`${a}/api/gateway/ask`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});console.log("‚úÖ Response received:",t.status,t.statusText);const s=await t.json();return console.log("üì¶ Response data:",s),s}catch(r){return console.error("‚ùå Ask question error:",r),{success:!1,error:r instanceof Error?r.message:"Network error"}}}export{m as a,T as b,A as c,S as d,k as e,c as f,w as g,p as i,y as l,d as r};
